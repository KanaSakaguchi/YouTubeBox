<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <base target="_top">
  </head>
  <body>
    <div id="app">
      <el-container>
        <el-header>
          <div>
            <h1>YouTube Box</h1>
          </div>
        </el-header>
        <el-main>
          <section>
            <h2>Player</h2>
            <div id="player">
            </div>
          </section>
        </el-main>
      </el-container>
    </div>

    <script src="https://unpkg.com/vue/dist/vue.js"></script>
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <script>
      new Vue({
        el: '#app',
      })

      var player
      var playingVideo

      function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', {
          height: '360',
          width: '640',
          events: {
            onStateChange: onPlayerStateChange
          }
        })
        loadVideo(false)
      }

      function loadVideo(isAutoPlay) {
        google.script.run
          .withSuccessHandler(function (video) {
            playingVideo = video
            player.loadVideoById(video.videoId)
            if (!isAutoPlay) {
              player.stopVideo()
            }
          })
          .getFirstOrder()
      }

      function onPlayerStateChange(event) {
        if (event.data !== YT.PlayerState.ENDED) {
          return
        }

        google.script.run
          .withSuccessHandler(function (existNextVideo) {
            if (existNextVideo) {
              google.script.run
                .withSuccessHandler(function () {
                  loadVideo(true)
                })
                .deleteOrder(playingVideo)
            }
          })
          .existNextVideo()
      }
    </script>
    <script src="https://www.youtube.com/iframe_api"></script>
  </body>
</html>
