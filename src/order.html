<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <base target="_top">
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <style>
      .inputKeyword {
        margin-bottom: 0;
      }
      .channelName .el-link {
        font-size: small;
      }
      .el-link.is-underline:hover:after {
        bottom: 5px;
      }
    </style>
  </head>
  <body>
    <div id="app" @submit.prevent>
      <el-container>
        <el-header>
          <h1>YouTube Box</h1>
        </el-header>
        <el-main>
          <section>
            <h2>Order</h2>
            <el-form label-width="0" ref="searchForm" :model="searchForm">
              <el-form-item class="inputKeyword" label="" prop="keyword">
                <el-input v-model="searchForm.keyword">
                  <el-button
                      slot="append"
                      native-type="submit"
                      icon="el-icon-search"
                      @click="search">
                  </el-button>
                </el-input>
              </el-form-item>
            </el-form>
            <div v-loading="isSearchLoading">
              <div v-show="searchResult.list">{{(searchResult.total || 0).toLocaleString()}} item(s) hit</div>
              <el-table
                  :data="searchResult.list"
                  style="width: 100%"
                  empty-text="No result."
                  :show-header="false"
                  stripe>
                <el-table-column
                    width="160">
                  <template slot-scope="list">
                    <el-image
                        :src="list.row.thumbnailUrl"
                        fit="contain">
                    </el-image>
                  </template>
                </el-table-column>
                <el-table-column>
                  <template slot-scope="list">
                    <el-link :href="list.row.url" type="primary" target="_blank">{{list.row.title}}</el-link><br>
                    {{list.row.videoLength}}<br>
                    <cite class="channelName">
                      <el-link :href="list.row.channelUrl" type="info" target="_blank">{{list.row.channelName}}</el-link>
                    </cite>
                  </template>
                </el-table-column>
              </el-table>
            </div>
          </section>
        </el-main>
      </el-container>
    </div>

    <script src="https://unpkg.com/vue/dist/vue.js"></script>
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <script>
      new Vue({
        el: '#app',
        data() {
          return {
            searchForm: {
              keyword: ''
            },
            isSearchLoading: false,
            searchResult: {}
          }
        },
        methods: {
          search() {
            this.isSearchLoading = true
            google.script.run
              .withSuccessHandler(this.setSearchResult)
              .search(this.searchForm.keyword)
          },
          setSearchResult(searchResult) {
            this.searchResult = searchResult
            this.isSearchLoading = false
            this.searchResult.list.forEach(function (video, index) {
              if (video.type === 'video') {
                google.script.run
                  .withSuccessHandler(function (videoResource) {
                    Vue.set(this.searchResult.list, index, videoResource)
                  }.bind(this))
                  .getVideoResource(video.id)
              } else {
                google.script.run
                  .withSuccessHandler(function (videoResource) {
                    Vue.set(this.searchResult.list, index, videoResource)
                  }.bind(this))
                  .getPlaylistResource(video.id)
              }
            }.bind(this))
          }
        }
      })
    </script>
  </body>
</html>
